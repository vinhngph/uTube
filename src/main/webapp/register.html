<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Registration Form</title>
    <style>
        .hidden {
            display: none;
        }
    </style>
</head>

<body>
    <div class="container">
        <form id="form-register" action="./register" method="POST">
            <div id="step1">
                <h2>Step 1: Account Information</h2>
                <label for="email">Email:</label><br>
                <input type="email" id="email" name="email" required><br>

                <label for="username">Username:</label><br>
                <input type="text" id="username" name="username" required><br>

                <label for="password">Password:</label><br>
                <input type="password" id="password" name="password" required><br><br>

                <input type="hidden" name="session_device" value="" id="session_device">
                <input type="hidden" name="session_time" value="" id="session_time">

                <button type="button" onclick="isExist()">Register</button>
            </div>

            <div id="step2" class="hidden">
                <h2>Step 2: Personal Information</h2>
                <label for="fullname">Full Name:</label><br>
                <input type="text" id="fullname" name="fullname" required><br>

                <label for="dob">Date of Birth:</label><br>
                <input type="date" id="dob" name="dob" required><br><br>

                <button type="button" onclick="prevStep()">Back</button>
                <button type="submit">Send</button>
            </div>
        </form>

        <h1 id="ERROR"></h1>
    </div>

    <script>
        function isExist() {
            let email = document.getElementById('email').value;
            let username = document.getElementById('username').value;

            let xhr = new XMLHttpRequest();
            xhr.open('POST', '/api/isUser', true);
            xhr.setRequestHeader('Content-Type', 'application/json');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 202) {
                        nextStep();
                    } else if (xhr.status === 406) {
                        document.getElementById("ERROR").innerText = "Email or username already exists!";
                    } else {
                        document.getElementById("ERROR").innerText = "Somethings wrong happen!";
                    }
                }
            };
            xhr.send(JSON.stringify({
                email: email,
                username: username
            }));
        }

        function nextStep() {
            document.getElementById("ERROR").style.display = "none";
            document.getElementById('step1').classList.add('hidden');
            document.getElementById('step2').classList.remove('hidden');
            let sessionDevice = window.navigator.userAgent;
            document.getElementById('session_device').value = sessionDevice;

            let year = new Date().getFullYear();
            let month = new Date().getMonth() + 1;
            let day = new Date().getDate();
            let hour = new Date().getHours();
            let minute = new Date().getMinutes();
            let second = new Date().getSeconds();
            let sessionTime = year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second;
            document.getElementById('session_time').value = sessionTime;
        }

        function prevStep() {
            document.getElementById('step2').classList.add('hidden');
            document.getElementById('step1').classList.remove('hidden');
        }

        document.getElementById('form-register').addEventListener('submit', function (e) {
            e.preventDefault();
            let formData = new FormData(this);
            let xhr = new XMLHttpRequest();
            xhr.open('POST', '/register', true);
            xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
            xhr.onreadystatechange = function () {
                if (xhr.readyState === 4) {
                    if (xhr.status === 200) {
                        window.location.href = '.';
                    } else if (xhr.status === 401) {
                        document.getElementById('ERROR').innerText = 'Failed to auto login!';
                    } else {
                        document.getElementById('ERROR').innerText = 'Failed to register!';
                    }
                }
            };
            xhr.send(new URLSearchParams(formData).toString());
        });
    </script>
</body>

</html>